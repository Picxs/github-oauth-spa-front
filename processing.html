<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processando - GitHub Repo Manager</title>
    <link rel="stylesheet" href="styles.css">
    <script src="src/config.js"></script>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>GitHub Repository Manager</h1>
            <div id="content">
                <div class="login-container">
                    <h2>Processando Autentica√ß√£o</h2>
                    <div class="loading-spinner"></div>
                    <p id="status">Iniciando processamento...</p>
                    <div id="instructions" style="display: none; margin-top: 20px; padding: 15px; background: #f6f8fa; border-radius: 6px;">
                        <h3>üìã Pr√≥ximos Passos:</h3>
                        <ol>
                            <li>Este processo simula a obten√ß√£o do token</li>
                            <li>Em produ√ß√£o, usaria GitHub Actions</li>
                            <li>Redirecionando para dashboard...</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
        Esta p√°gina foi criada como um intermedi√°rio entre o callback do GitHub e a aplica√ß√£o principal.
         Ela simula o servidor de troca de tokens que, em uma aplica√ß√£o real, 
         seria necess√°rio mas n√£o consegui implementar em uma SPA hospedada no GitHub Pages.
         A implementa√ß√£o atual gera um token simulado e determina aleatoriamente se o usu√°rio √© Viewer ou Manager 
         (com 70% de chance de ser Manager para demonstra√ß√£o). Esta abordagem foi escolhida por duas raz√µes: 1) 
          Evitar expor client_secret no front-end (que seria inseguro), e 2) 
          Permitir a demonstra√ß√£o completa do fluxo PKCE mesmo sem um backend. 
        */
        async function processAuthentication() {
            const statusEl = document.getElementById('status');
            const instructionsEl = document.getElementById('instructions');
            
            try {
                statusEl.textContent = 'Recuperando dados de autentica√ß√£o...';
                
                // Recuperar dados do sessionStorage
                const authData = sessionStorage.getItem('pending_auth');
                if (!authData) {
                    throw new Error('Dados de autentica√ß√£o n√£o encontrados');
                }

                const { code, code_verifier, client_id } = JSON.parse(authData);
                
                statusEl.textContent = 'Simulando troca de token...';
                instructionsEl.style.display = 'block';

                // SIMULA√á√ÉO: Em produ√ß√£o real, isso seria feito por GitHub Actions
                // Aqui vamos simular um token e determinar escopo baseado nas permiss√µes
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                statusEl.textContent = 'Criando sess√£o de usu√°rio...';

                // Simular token de acesso (em produ√ß√£o real, viria do GitHub)
                const mockToken = "gho_simulated_" + Math.random().toString(36).substr(2, 20);
                
                // Determinar escopo baseado em probabilidade ou l√≥gica espec√≠fica
                // Para demonstra√ß√£o, vamos alternar entre manager e viewer
                const userScope = Math.random() > 0.3 ? 'manager' : 'viewer';
                
                // Salvar token e escopo
                sessionStorage.setItem('access_token', mockToken);
                sessionStorage.setItem('user_scope', userScope);
                
                // Limpar dados tempor√°rios
                sessionStorage.removeItem('pending_auth');
                sessionStorage.removeItem('pkce_code_verifier');
                sessionStorage.removeItem('oauth_state');
                
                statusEl.textContent = 'Autentica√ß√£o simulada conclu√≠da! Redirecionando...';
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);

            } catch (error) {
                console.error('Erro no processamento:', error);
                statusEl.textContent = 'Erro: ' + error.message;
                statusEl.style.color = 'red';
                
                sessionStorage.removeItem('pending_auth');
                sessionStorage.removeItem('pkce_code_verifier');
                sessionStorage.removeItem('oauth_state');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', processAuthentication);
    </script>
</body>
</html>