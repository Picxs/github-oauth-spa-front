<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processando - GitHub Repo Manager</title>
    <link rel="stylesheet" href="styles.css">
    <script src="src/config.js"></script>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>GitHub Repository Manager</h1>
            <div id="content">
                <div class="login-container">
                    <h2>Processando Autentica√ß√£o</h2>
                    <div class="loading-spinner"></div>
                    <p id="status">Iniciando processamento...</p>
                    <div id="error" style="display: none; margin-top: 20px; padding: 15px; background: #ffebee; border: 1px solid #f44336; border-radius: 6px; color: #c62828;">
                        <h3>‚ùå Erro na Autentica√ß√£o</h3>
                        <p id="error-message"></p>
                        <button onclick="window.location.href='index.html'" class="btn-primary">Voltar ao Login</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function exchangeCodeForToken(code, codeVerifier, clientId) {
            console.log('üîÑ Iniciando troca de c√≥digo por token...');
            
            const response = await fetch('https://github.com/login/oauth/access_token', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    client_id: clientId,
                    client_secret: '', // Vazio para PKCE em SPA
                    code: code,
                    code_verifier: codeVerifier,
                    redirect_uri: 'https://picxs.github.io/github-oauth-spa-front/callback.html'
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const tokenData = await response.json();
            console.log('üì¶ Resposta do token:', tokenData);

            if (tokenData.error) {
                throw new Error(`GitHub OAuth error: ${tokenData.error_description || tokenData.error}`);
            }

            if (!tokenData.access_token) {
                throw new Error('Access token n√£o recebido na resposta');
            }

            return tokenData;
        }

        async function getUserInfo(accessToken) {
            console.log('üîç Obtendo informa√ß√µes do usu√°rio...');
            
            const response = await fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'User-Agent': 'GitHub-OAuth-SPA'
                }
            });

            if (!response.ok) {
                throw new Error(`Erro ao obter user info: ${response.status}`);
            }

            return await response.json();
        }

        async function determineUserScope(accessToken) {
            try {
                console.log('üéØ Determinando escopo do usu√°rio...');
                
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-OAuth-SPA'
                    }
                });

                if (!response.ok) {
                    throw new Error('Falha ao verificar escopos');
                }

                // Verificar escopos no header da resposta
                const scopesHeader = response.headers.get('x-oauth-scopes');
                console.log('üìã Escopos concedidos:', scopesHeader);

                if (scopesHeader) {
                    // Verificar se tem permiss√µes de escrita (repo scope)
                    const hasRepoScope = scopesHeader.includes('repo');
                    const hasWriteScope = scopesHeader.includes('write');
                    
                    console.log('üîç An√°lise de escopos:', {
                        hasRepoScope,
                        hasWriteScope,
                        scopesHeader
                    });

                    return hasRepoScope ? 'manager' : 'viewer';
                }

                // Fallback: tentar fazer uma opera√ß√£o de escrita para testar permiss√µes
                console.log('‚ö†Ô∏è  Headers de escopo n√£o dispon√≠veis, testando permiss√µes...');
                const userInfo = await response.json();
                
                // Tentar listar reposit√≥rios (opera√ß√£o de leitura sempre permitida)
                const reposResponse = await fetch('https://api.github.com/user/repos?per_page=1', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'User-Agent': 'GitHub-OAuth-SPA'
                    }
                });

                if (reposResponse.ok) {
                    // Se consegue listar reposit√≥rios, verificar se tem permiss√µes de escrita
                    // tentando criar um reposit√≥rio de teste (que ser√° deletado imediatamente)
                    try {
                        const testRepoResponse = await fetch('https://api.github.com/user/repos', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json',
                                'User-Agent': 'GitHub-OAuth-SPA'
                            },
                            body: JSON.stringify({
                                name: 'test-permission-check-' + Date.now(),
                                description: 'Reposit√≥rio tempor√°rio para verifica√ß√£o de permiss√µes - ser√° deletado',
                                private: true,
                                auto_init: false
                            })
                        });

                        if (testRepoResponse.status === 201) {
                            const testRepo = await testRepoResponse.json();
                            console.log('‚úÖ Permiss√µes de escrita confirmadas - deletando reposit√≥rio de teste...');
                            
                            // Deletar o reposit√≥rio de teste imediatamente
                            await fetch(`https://api.github.com/repos/${userInfo.login}/${testRepo.name}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`,
                                    'User-Agent': 'GitHub-OAuth-SPA'
                                }
                            });
                            
                            return 'manager';
                        }
                    } catch (writeError) {
                        console.log('‚ùå Sem permiss√µes de escrita:', writeError.message);
                    }
                }

                return 'viewer';

            } catch (error) {
                console.error('‚ùå Erro ao determinar escopo:', error);
                // Em caso de erro, assumir perfil mais restritivo (viewer)
                return 'viewer';
            }
        }

        async function processAuthentication() {
            const statusEl = document.getElementById('status');
            const errorEl = document.getElementById('error');
            
            try {
                statusEl.textContent = 'Recuperando dados de autentica√ß√£o...';
                
                // Recuperar dados do sessionStorage
                const authData = sessionStorage.getItem('pending_auth');
                if (!authData) {
                    throw new Error('Dados de autentica√ß√£o n√£o encontrados. Por favor, inicie o login novamente.');
                }

                const { code, code_verifier, client_id } = JSON.parse(authData);
                
                if (!code || !code_verifier || !client_id) {
                    throw new Error('Dados de autentica√ß√£o incompletos.');
                }

                console.log('üì¶ Dados de autentica√ß√£o:', { 
                    code: code.substring(0, 10) + '...', 
                    code_verifier: code_verifier.substring(0, 10) + '...',
                    client_id: client_id.substring(0, 10) + '...'
                });

                statusEl.textContent = 'Trocando c√≥digo por token de acesso...';

                // FAZER A TROCA REAL DE TOKENS
                const tokenData = await exchangeCodeForToken(code, code_verifier, client_id);
                
                statusEl.textContent = 'Obtendo informa√ß√µes do usu√°rio...';

                // Obter informa√ß√µes do usu√°rio
                const userInfo = await getUserInfo(tokenData.access_token);
                console.log('üë§ Informa√ß√µes do usu√°rio:', userInfo);

                statusEl.textContent = 'Verificando permiss√µes...';

                // Determinar escopo baseado nas permiss√µes reais
                const userScope = await determineUserScope(tokenData.access_token);
                console.log('üéØ Escopo determinado:', userScope);

                statusEl.textContent = 'Criando sess√£o...';

                // Salvar token e informa√ß√µes no sessionStorage
                sessionStorage.setItem('access_token', tokenData.access_token);
                sessionStorage.setItem('user_scope', userScope);
                sessionStorage.setItem('user_info', JSON.stringify(userInfo));
                
                // Limpar dados tempor√°rios
                sessionStorage.removeItem('pending_auth');
                sessionStorage.removeItem('pkce_code_verifier');
                sessionStorage.removeItem('oauth_state');
                
                statusEl.textContent = 'Autentica√ß√£o conclu√≠da! Redirecionando...';
                console.log('‚úÖ Autentica√ß√£o REAL conclu√≠da com sucesso!');

                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);

            } catch (error) {
                console.error('‚ùå Erro no processamento:', error);
                statusEl.style.display = 'none';
                errorEl.style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
                
                // Limpar dados de autentica√ß√£o em caso de erro
                sessionStorage.removeItem('pending_auth');
                sessionStorage.removeItem('pkce_code_verifier');
                sessionStorage.removeItem('oauth_state');
                sessionStorage.removeItem('access_token');
                sessionStorage.removeItem('user_scope');
            }
        }

        document.addEventListener('DOMContentLoaded', processAuthentication);
    </script>
</body>
</html>