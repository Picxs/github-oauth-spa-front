#Implementa um workflow de GitHub Actions que automatiza o deploy para o GitHub Pages. 
#O passo mais importante Ã© o "Build SPA with injected secrets", 
#que substitui os placeholders pelos valores reais dos secrets do repositÃ³rio usando sed. 
#Isso garante que o CLIENT_ID real seja injetado na aplicaÃ§Ã£o sem nunca aparecer no cÃ³digo fonte. 

name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Build SPA with injected secrets
      run: |
        # Criar diretÃ³rio de output
        mkdir -p dist
        
        # Processar HTMLs para injetar CLIENT_ID
        for file in index.html callback.html processing.html; do
          if [ -f "$file" ]; then
            echo "ðŸ”„ Processando $file..."
            sed "s/PLACEHOLDER_CLIENT_ID/${{ secrets.AUTH_CLIENT_ID }}/g" "$file" > "dist/$file"
            echo "âœ… $file processado"
          else
            echo "âš ï¸  $file nÃ£o encontrado, pulando..."
          fi
        done
        
        # Criar diretÃ³rio src dentro de dist
        mkdir -p dist/src
        
        # Criar arquivo de configuraÃ§Ã£o com o PAT
        cat > dist/src/config.js << 'EOF'
        // ConfiguraÃ§Ãµes injetadas pelo GitHub Actions
        window.CLIENT_ID = '${{ secrets.AUTH_CLIENT_ID }}';
        window.GITHUB_PAT = '${{ secrets.MY_PAT }}';
        window.REAL_DATA_MODE = true;
        console.log('ðŸ”§ ConfiguraÃ§Ãµes carregadas - Modo REAL ativado');
        EOF
        
        # Copiar o app.js original (sem modificaÃ§Ãµes)
        if [ -f "src/app.js" ]; then
          cp src/app.js dist/src/
          echo "âœ… app.js copiado"
        else
          echo "âŒ src/app.js nÃ£o encontrado!"
          exit 1
        fi
        
        # Copiar styles.css
        if [ -f "styles.css" ]; then
          cp styles.css dist/
          echo "âœ… styles.css copiado"
        else
          echo "âš ï¸  styles.css nÃ£o encontrado"
        fi
        
        # Verificar estrutura criada
        echo "ðŸ“ Estrutura final:"
        find dist -type f -name "*.html" -o -name "*.js" -o -name "*.css" | sort

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: dist

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4